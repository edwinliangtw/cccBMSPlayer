{"version":3,"sources":["file:///Users/edwin/Desktop/CCCGame/cccBMSPlayer/assets/scripts/core/BMSMain.ts"],"names":["_decorator","Component","Node","Layers","UITransform","UIOpacity","Sprite","tween","math","BMSLoader","ccclass","property","BMSMain","bms","bmpRC","wavRC","dataRC","barRC","measureInfo","displaySprite","displayTrans","startTime","onLoad","resourceURL","loadBMS","loadImages","type","cur","total","filename","console","log","loadSounds","JSON","parse","stringify","data","generateBarsWithDuration","node","sp","trans","opacity","createImage","loop","bind","performance","now","requestAnimationFrame","tDiff","i","l","bmp","id","length","timing","frame","spriteFrame","width","height","shift","wav","audio","playOneShot","clip","j","jl","note","key","keyslen","map","info","reduce","s","bar","x","setPosition","to","position","Vec3","easing","call","removeChild","start","duration","keyArr","d","result","keys","il","Object","forEach","tk","push","t","sf","container","alpha","layer","Enum","UI_2D","addComponent","addChild"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, SpriteFrame, Layers, UITransform, UIOpacity, Sprite, assetManager, ImageAsset, Texture2D, AudioSource, tween, math } from 'cc';\nimport { BMSData } from './BMSData';\nimport { BMSLoader } from './BMSLoader';\nconst { ccclass, property } = _decorator;\n\n/**\n * bms player by \n * Edwin Liang\n * edwinliang.tw@gmail.com\n * (本版不含遊玩功能, 僅播放功能)\n */\n\n@ccclass('BMSMain')\nexport class BMSMain extends Component {\n\n    // 遊戲音樂包資訊\n    private bms: BMSData; // 所有 bms 解碼資訊\n    private bmpRC; // 圖片資訊\n    private wavRC; // 聲音資訊\n    private dataRC; // 播放資訊\n    private barRC; // 遊戲音符出現資訊\n    // 小節資訊\n    private measureInfo;\n    // 動畫視圖\n    private displaySprite: Sprite;\n    private displayTrans: UITransform;\n    // 播放起始時間\n    private startTime = 0;\n\n    async onLoad() {\n\n        // 所有 bms 音樂包下載處 (bms download place: https://www.bmsworld.nz/)\n        // cranKy – J219, (147BPM Genre, Euro Beat ^^ Fan Made)\n        // [youtube J219] https://www.youtube.com/watch?v=jp4cjU8NLZQ&width=1280&height=720\n        // [download J219] https://mega.co.nz/#!yQoBmYib!X5dXTxxRjJEmz4isPQ402xFAfvWZ3ttXdtR8T1twBpk\n        // 請自行用 vscode live server 架 server 放音樂包測試 \n        let resourceURL = 'http://127.0.0.1:5500/cranky%20%5BEURO%20BEAT%5D%20J219/'\n\n        // 產生遊戲歌曲相關資源\n        this.bms = await BMSLoader.loadBMS(resourceURL, 'J219.bms') as any;\n        this.bmpRC = await BMSLoader.loadImages((type, cur, total, filename) => {\n            console.log(type, cur, '/', total, filename, 'loaded')\n        });\n        this.wavRC = await BMSLoader.loadSounds((type, cur, total, filename) => {\n            console.log(type, cur, '/', total, filename, 'loaded')\n        });\n        this.dataRC = JSON.parse(JSON.stringify(this.bms.data));\n        this.barRC = this.generateBarsWithDuration(this.bms.data, 2000);\n        // 動畫視圖\n        let { node, sp, trans, opacity } = this.createImage(null, this.node)\n        this.displaySprite = sp;\n        this.displayTrans = trans\n        // 動畫迴圈\n        this.loop = this.loop.bind(this)\n        this.startTime = performance.now();\n        requestAnimationFrame(this.loop);\n\n        console.log(this.bms)\n    }\n\n    private loop() {\n        const tDiff = performance.now() - this.startTime\n        if (this.measureInfo) {\n            // 圖像播放\n            for (let i = 0, l = this.measureInfo.bmp.id.length; i < l; i++) {\n                if (tDiff > this.measureInfo.bmp.timing[i]) {\n                    let frame = this.bmpRC[this.measureInfo.bmp.id[i]];\n                    this.displaySprite.spriteFrame = frame;\n                    this.displayTrans.width = this.displayTrans.height = 640;\n                    this.measureInfo.bmp.id.shift();\n                    this.measureInfo.bmp.timing.shift();\n                    i--;\n                    l--;\n                } else break;\n            }\n            // 聲音播放\n            for (let i = 0, l = this.measureInfo.wav.id.length; i < l; i++) {\n                if (tDiff > this.measureInfo.wav.timing[i]) {\n                    let audio = this.wavRC[this.measureInfo.wav.id[i]];\n                    audio.playOneShot(audio.clip, 1);\n                    this.measureInfo.wav.id.shift();\n                    this.measureInfo.wav.timing.shift();\n                    i--;\n                    l--;\n                } else break;\n            }\n            // 音符播放\n            for (let j = 0, jl = this.measureInfo.note.key.length; j < jl; j++) {\n                let key = this.measureInfo.note.key[j];\n                for (let i = 0, l = key.id.length; i < l; i++) {\n                    if (tDiff > key.timing[i]) {\n                        let audio = this.wavRC[key.id[i]];\n                        audio.playOneShot(audio.clip, 1);\n                        key.id.shift();\n                        key.timing.shift();\n                        i--;\n                        l--;\n                    } else break;\n                }\n            }\n            // 確認音符播放完畢 keyslen == 0\n            let keyslen = this.measureInfo.note.key.map(info => info.length).reduce((i, s) => i + s);\n            // 聲音圖像播完換下一小節\n            if (!this.measureInfo.wav.id.length && !this.measureInfo.bmp.id.length && !keyslen) {\n                this.dataRC.shift();\n                this.measureInfo = null;\n            }\n        }\n        // 取得小節資訊\n        if (!this.measureInfo) {\n            for (let i = 0, l = this.dataRC.length; i < l; i++) {\n                let info = this.dataRC[i]\n                if (tDiff > info.timing) {\n                    this.measureInfo = info;\n                    i--;\n                    l--;\n                } else break;\n            }\n        }\n        // 音符在指定時間出現\n        for (let j = 0, jl = this.barRC.length; j < jl; j++) {\n            let bar = this.barRC[j]\n            for (let i = 0, l = bar.id.length; i < l; i++) {\n                if (tDiff > bar.timing[i]) {\n                    let { node, sp, trans, opacity } = this.createImage(this.bmpRC[0], this.node);\n                    trans.width = 50;\n                    trans.height = 20;\n                    let x = trans.width * j - 640 * .5 + 100\n                    node.setPosition(x, 1136 * .5)\n                    tween(node).to(2, { position: new math.Vec3(x, -1136 * .5 + 100) }, { easing: \"linear\" })\n                        .call(() => {\n                            this.node.removeChild(node);\n                        })\n                        .start();\n                    bar.id.shift();\n                    bar.timing.shift();\n                    i--;\n                    l--;\n                } else break;\n            }\n        }\n        requestAnimationFrame(this.loop)\n    }\n\n    /**\n     * 音符出現資源設定 (所有音符提早 duration 時間出現)\n     * @param data bms.data\n     * @param duration 音符出現時間設定 (毫秒)\n     * @returns \n     */\n    private generateBarsWithDuration(data, duration) {\n        const keyArr = data.map(d => d.note.key)\n        let timing = {}\n        let id = {}\n        let result = []\n        for (let j = 0, jl = keyArr.length; j < jl; j++) {\n            const keys = keyArr[j]\n            for (let i = 0, il = keys.length; i < il; i++) {\n                timing[i] = timing[i] || []\n                timing[i] = [...timing[i], ...keys[i].timing]\n                id[i] = id[i] || []\n                id[i] = [...id[i], ...keys[i].id]\n            }\n        }\n        Object.keys(timing).forEach(tk => result.push({ id: id[tk], timing: timing[tk].map(t => t - duration) }))\n        return result;\n    }\n\n    /**\n     * 動態產生圖在容器裡\n     * @param sf SpriteFrame\n     * @param container 父容器\n     * @param alpha 透明度\n     * @returns \n     */\n    private createImage(sf: SpriteFrame, container: Node, alpha: number = 255) {\n        let node = new Node;\n        node.layer = Layers.Enum.UI_2D;\n        let trans = node.addComponent(UITransform)\n        let opacity = node.addComponent(UIOpacity)\n        opacity.opacity = alpha;\n        let sp = node.addComponent(Sprite);\n        sp.spriteFrame = sf;\n        container.addChild(node);\n        return { node, sp, trans, opacity };\n    }\n}\n\n"]}
{"version":3,"sources":["file:///Users/edwin/Desktop/CCCGame/cccBMSPlayer/assets/scripts/core/BMSParser.ts"],"names":["BMSParser","BMSData","bms","wavMessages","_lcm","a","b","gcm","x","y","_expand","array","length","Array","fill","interval","results","i","push","_merge","ary1","ary2","lcm","ret","ref","l","value","parse","rawText","split","forEach","row","_parse","_modifyAfterParse","bpms","timing","val","bpm","_serialize","data","animations","bgms","stopTiming","totalNote","_calcTotalNote","total","substring","wav","exec","_parseWAV","bmp","_parseBMP","stop","_parseSTOP","exbpm","_parseBPM","channelMsg","_parseChannelMsg","property","_parseProperty","parseInt","toLowerCase","msg","measureNum","ch","_createBar","_storeWAV","meter","parseFloat","_storeBPM","_storeData","_storeEXBPM","_storeSTOP","note","key","message","id","JSON","stringify","slice","time","dl","bar","_noteTiming","_bmpTiming","_stopTiming","_wavTiming","timeList","j","ml","_calcTiming","objects","bpmobj","bl","ol","objs","t","endTime","wavss","result","wl","ws","wavs","sorted","sort","k","sl","w","arr","name","bms_data","serialized","bmsData","_len1","reduce","d","nt"],"mappings":"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","sourcesContent":["import { BMSData } from \"./BMSData\"\n\n/**\n * https://github.com/bokuweb/bmsjs/\n * bmsjs typescript version recoded by\n * Edwin Liang\n * edwinliang.tw@gmail.com\n */\nexport class BMSParser {\n\n    private bms: BMSData\n    private wavMessages\n\n    // 主解析函式\n    parse(rawText) {\n        this.bms = new BMSData;\n        this.wavMessages = []\n        rawText.split('\\n').forEach(row => this._parse(row));\n        this._modifyAfterParse();\n        this.bms.bpms[0] = {\n            timing: 0,\n            val: this.bms.bpm\n        };\n        this._serialize(this.bms.bpms, \"bpm\", this.bms.data);\n        this._serialize(this.bms.animations, \"bmp\", this.bms.data);\n        this._serialize(this.bms.bgms, \"wav\", this.bms.data);\n        this._serialize(this.bms.stopTiming, \"stop\", this.bms.data);\n        this.bms.totalNote = this._calcTotalNote();\n        if (this.bms.total == null) {\n            this.bms.total = 200 + this.bms.totalNote;\n        }\n        return this.bms;\n    }\n\n    private _parse(row: string) {\n\n        // #開頭才是有用的資訊, 程式才往下跑\n        if (row.substring(0, 1) !== '#') {\n            return;\n        }\n        // 比對聲音資訊返回聲音清單\n        let wav = /^#WAV(\\w{2}) +(.*)/.exec(row);\n        if (wav != null) {\n            this._parseWAV(wav);\n            return;\n        }\n        // 比對圖片索引返回圖片清單\n        let bmp = /^#BMP(\\w{2}) +(.*)/.exec(row);\n        if (bmp != null) {\n            this._parseBMP(bmp);\n            return;\n        }\n        // 比對停止資訊返回停止資訊清單\n        let stop = /^#STOP(\\w{2}) +(.*)/.exec(row);\n        if (stop != null) {\n            this._parseSTOP(stop);\n            return;\n        }\n        // 比對BPM資訊返回BPM資訊清單\n        let exbpm = /^#BPM(\\w{2}) +(.*)/.exec(row);\n        if (exbpm != null) {\n            this._parseBPM(exbpm);\n            return;\n        }\n        // 比對Channel資訊返回Channel資訊清單\n        let channelMsg = /^#([0-9]{3})([0-9]{2}):([\\w\\.]+)/.exec(row);\n        if (channelMsg != null) {\n            this._parseChannelMsg(channelMsg);\n            return;\n        }\n        // 比對Property資訊返回Property資訊清單 (HEADER基本資訊)\n        let property = /^#(\\w+) +(.+)/.exec(row);\n        if (property != null) {\n            this._parseProperty(property);\n        }\n    }\n    private _parseWAV(wav) {\n        // 正規表達式回傳陣列前兩個值作為 k v\n        return this.bms.wav[parseInt(wav[1], 36)] = wav[2];\n    }\n    private _parseBMP(bmp) {\n        // 正規表達式回傳陣列前兩個值作為 k v\n        return this.bms.bmp[parseInt(bmp[1], 36)] = bmp[2];\n    }\n    private _parseSTOP(stop) {\n        // 正規表達式回傳陣列前兩個值作為 k v\n        return this.bms.stop[parseInt(stop[1], 36)] = stop[2];\n    }\n    private _parseBPM(exbpm) {\n        // 正規表達式回傳陣列前兩個值作為 k v\n        return this.bms.exbpm[parseInt(exbpm[1], 36)] = exbpm[2];\n    }\n    private _parseProperty(property) {\n        // 正規表達式回傳陣列前兩個值作為 k v\n        return this.bms[property[1].toLowerCase()] = property[2];\n    }\n    private _parseChannelMsg(msg) {\n        // 第幾小節\n        let measureNum = parseInt(msg[1]);\n        // 第幾channel\n        let ch = parseInt(msg[2]);\n        // channel資料\n        let data = msg[3];\n        // 建立空資料結構\n        if (this.bms.data[measureNum] == null) {\n            this.bms.data[measureNum] = this._createBar();\n        }\n        switch (ch) {\n            case 1: // 儲存 wav 資訊\n                return this._storeWAV(data, this.bms.data[measureNum].wav, measureNum);\n            case 2: // 儲存 meter 節拍\n                let meter = parseFloat(data);\n                if (meter > 0) {\n                    return this.bms.data[measureNum].meter = meter;\n                }\n                break;\n            case 3: // 儲存 bpm 資訊\n                return this._storeBPM(data, this.bms.data[measureNum].bpm);\n            case 4: // 儲存 圖片\n                return this._storeData(data, this.bms.data[measureNum].bmp);\n            case 8: // 儲存 bpm 資訊\n                return this._storeEXBPM(data, this.bms.data[measureNum].bpm);\n            case 9: // 儲存 暫停\n                return this._storeSTOP(data, this.bms.data[measureNum].stop);\n            case 11:\n            case 12:\n            case 13:\n            case 14:\n            case 15: // 儲存 note 資訊\n                return this._storeData(data, this.bms.data[measureNum].note.key[ch - 11]);\n            case 16:\n            case 17: // 儲存 note 資訊\n                return this._storeData(data, this.bms.data[measureNum].note.key[ch - 9]);\n            case 18:\n            case 19: // 儲存 note 資訊\n                return this._storeData(data, this.bms.data[measureNum].note.key[ch - 13]);\n        }\n    }\n\n    private _createBar() {\n        return {\n            timing: 0.0,\n            wav: {\n                message: [],\n                timing: [],\n                id: []\n            },\n            bmp: {\n                message: [],\n                timing: [],\n                id: []\n            },\n            bpm: {\n                message: [],\n                timing: [],\n                val: []\n            },\n            stop: {\n                message: [],\n                timing: [],\n                id: []\n            },\n            meter: 1.0,\n            note: {\n                key: JSON.parse(JSON.stringify(Array(9).fill({\n                    message: [],\n                    timing: [],\n                    id: []\n                })))\n            }\n        };\n    }\n\n    /** store */\n    private _storeWAV(msg, array, measureNum) {\n        this.wavMessages[measureNum] = this.wavMessages[measureNum] || [];\n        let results = [];\n        for (let i = 0, l = msg.length; i < l; i += 2)\n            results.push(parseInt(msg.slice(i, i + 2), 36));\n        return this.wavMessages[measureNum].push(results);\n    }\n    private _storeData(msg, array) {\n        let results = [];\n        for (let i = 0, l = msg.length; i < l; i += 2)\n            results.push(parseInt(msg.slice(i, i + 2), 36));\n        return array.message = this._merge(array.message, results);\n    }\n    private _storeSTOP(msg, array) {\n        let results = [];\n        for (let i = 0, l = msg.length; i < l; i += 2)\n            results.push(parseInt(msg.slice(i, i + 2), 36));\n        return array.message = this._merge(array.message, results);\n    }\n    private _storeBPM(msg, bpm) {\n        let results = [];\n        for (let i = 0, l = msg.length; i < l; i += 2)\n            results.push(parseInt(msg.slice(i, i + 2), 36));\n        return bpm.message = results;\n    }\n    private _storeEXBPM(msg, bpm) {\n        let results = [];\n        for (let i = 0, l = msg.length; i < l; i += 2) {\n            if (this.bms.exbpm[parseInt(msg.slice(i, i + 2), 16)] != null) {\n                results.push(parseFloat(this.bms.exbpm[parseInt(msg.slice(i, i + 2), 16)]));\n            } else {\n                results.push(0);\n            }\n        }\n        return bpm.message = results\n    }\n\n    /** tool */\n    _lcm = (a, b) => {\n        const gcm = (x, y) => y === 0 ? x : gcm(y, x % y)\n        return a / gcm(a, b) * b;\n    }\n\n    // ex. expand([1,2,3],6) == [1,0,2,0,3,0]\n    _expand = function (array, length) {\n        if (array.length === 0)\n            return Array(length).fill(0);\n        let interval = length / array.length;\n        let results = [];\n        for (let i = 0; i < length; i++)\n            results.push(i % interval === 0 ? array[i / interval] : 0);\n        return results;\n    }\n\n    // ex. merge([1,2,3], [0,4,0]) == [1,4,3]\n    _merge = function (ary1, ary2) {\n        if (ary1.length === 0) return ary2;\n        let lcm = this._lcm(ary1.length, ary2.length);\n        let ret = this._expand(ary1, lcm);\n        let ref = this._expand(ary2, lcm);\n        for (let i = 0, l = ref.length; i < l; i++) {\n            let value = ref[i];\n            if (value === 0) continue;\n            ret[i] = value;\n        }\n        return ret;\n    }\n\n    // 解析整體後修復時間等\n    private _modifyAfterParse() {\n        let bpm = parseFloat(this.bms.bpm);\n        let data = this.bms.data;\n        let time = 0;\n        let results = [];\n        for (let i = 0, dl = data.length; i < dl; i++) {\n            let bar = data[i];\n            if (bar == null) {\n                this.bms.data[i] = this._createBar();\n                this.bms.data[i].timing = time;\n                time += 240000 / bpm;\n                continue;\n            }\n            bar.timing = time;\n            if (bar.bpm.message.length === 0)\n                bar.bpm.message = [0];\n            this._noteTiming(time, bar, bpm);\n            this._bmpTiming(time, bar, bpm);\n            this._stopTiming(time, bar, bpm);\n            this._wavTiming(time, bar, bpm, this.wavMessages[i]);\n            let timeList = [];\n            for (let j = 0, ml = bar.bpm.message.length; j < ml; j++) {\n                let val = bar.bpm.message[j];\n                if (val !== 0) {\n                    bar.bpm.val.push(val);\n                    bar.bpm.timing.push(time);\n                    bpm = val;\n                }\n                time += (240000 / bpm) * (1 / ml) * bar.meter\n                timeList.push(time);\n            }\n            results.push(timeList);\n        }\n        return results;\n    }\n    // 出現時間計算\n    private _calcTiming(time, objects, bpmobj, bpm, meter) {\n        let bl = bpmobj.message.length;\n        let ol = objects.message.length;\n        let lcm = this._lcm(bl, ol);\n        let bpms = this._expand(bpmobj.message, lcm);\n        let objs = this._expand(objects.message, lcm);\n        let t = 0;\n        let b = bpm;\n        objects.timing = [];\n        objects.id = [];\n        for (let i = 0, l = bpms.length; i < l; i++) {\n            let val = bpms[i];\n            if (objs[i] !== 0) {\n                objects.timing.push(time + t);\n                objects.id.push(objs[i]);\n                if (this.bms.endTime < time + t) {\n                    this.bms.endTime = time + t;\n                }\n            }\n            if (val !== 0) {\n                b = val;\n            }\n            t += (240000 / b) * (1 / lcm) * meter;\n        }\n    }\n    // 音符出現時間\n    private _noteTiming(time, bar, bpm) {\n        for (let i = 0, l = bar.note.key.length; i < l; i++) {\n            let key = bar.note.key[i];\n            if (key.message.length !== 0) {\n                this._calcTiming(time, key, bar.bpm, bpm, bar.meter);\n            }\n        }\n    }\n    // 圖片出現時間\n    private _bmpTiming(time, bar, bpm) {\n        return this._calcTiming(time, bar.bmp, bar.bpm, bpm, bar.meter);\n    }\n    // 暫停出現時間\n    private _stopTiming(time, bar, bpm) {\n        return this._calcTiming(time, bar.stop, bar.bpm, bpm, bar.meter);\n    }\n    // 聲音出現時間\n    private _wavTiming(time, bar, bpm, wavss) {\n        if (wavss == null) return;\n        let result = [];\n        for (let i = 0, wl = wavss.length; i < wl; i++) {\n            let ws = wavss[i];\n            let lcm = this._lcm(bar.bpm.message.length, ws.length);\n            let bpms = this._expand(bar.bpm.message, lcm);\n            let wavs = this._expand(ws, lcm);\n            let t = 0;\n            let b = bpm;\n            for (let j = 0, bl = bpms.length; j < bl; j++) {\n                let val = bpms[j];\n                if (wavs[j] !== 0) {\n                    result.push({\n                        timing: time + t,\n                        id: wavs[j]\n                    });\n                    if (this.bms.endTime < time + t) {\n                        this.bms.endTime = time + t;\n                    }\n                }\n                if (val !== 0) {\n                    b = val;\n                }\n                t += (240000 / b) * (1 / lcm) * bar.meter;\n            }\n        }\n        let sorted = result.sort((a, b) => a.timing - b.timing);\n        let results = [];\n        for (let k = 0, sl = sorted.length; k < sl; k++) {\n            let w = sorted[k];\n            bar.wav.timing.push(w.timing);\n            results.push(bar.wav.id.push(w.id));\n        }\n        return results;\n    }\n    // 資料序列化\n    private _serialize(arr, name, bms_data) {\n        let serialized = [];\n        for (let i = 0, bl = bms_data.length; i < bl; i++) {\n            let bmsData = bms_data[i];\n            serialized.push((function () {\n                let timing = bmsData[name].timing;\n                let results = [];\n                for (let j = 0, _len1 = timing.length; j < _len1; j++) {\n                    let t = timing[j];\n                    if (t != null) {\n                        if (bmsData[name].val != null) {\n                            results.push(arr.push({\n                                timing: t,\n                                val: bmsData[name].val[j]\n                            }));\n                        } else if (bmsData[name].id != null) {\n                            results.push(arr.push({\n                                timing: t,\n                                id: bmsData[name].id[j]\n                            }));\n                        } else {\n                            results.push(void 0);\n                        }\n                    }\n                }\n                return results;\n            })());\n        }\n        return serialized;\n    }\n    // 計算音符數\n    private _calcTotalNote() {\n        return this.bms.data.reduce((t, d) => {\n            return t + d.note.key.reduce((nt, k) => {\n                return nt + k.id.length;\n            }, 0);\n        }, 0);\n    }\n}"]}